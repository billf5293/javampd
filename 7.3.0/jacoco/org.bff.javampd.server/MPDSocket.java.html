<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MPDSocket.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JavaMPD</a> &gt; <a href="index.source.html" class="el_package">org.bff.javampd.server</a> &gt; <span class="el_source">MPDSocket.java</span></div><h1>MPDSocket.java</h1><pre class="source lang-java linenums">package org.bff.javampd.server;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.Socket;
import java.net.SocketAddress;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import lombok.Getter;
import lombok.extern.slf4j.Slf4j;
import org.bff.javampd.MPDException;
import org.bff.javampd.command.MPDCommand;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @author bill
 */
<span class="fc" id="L23">@Slf4j</span>
public class MPDSocket {
<span class="fc" id="L25">  private static final Logger LOGGER = LoggerFactory.getLogger(MPDSocket.class);</span>

  private Socket socket;
  private BufferedReader reader;

  private final ResponseProperties responseProperties;
  private final ServerProperties serverProperties;
  private final String encoding;
  private String lastError;
<span class="fc" id="L34">  @Getter private String version;</span>

  private final String server;
  private final int port;
  private boolean closed;

  private static final int TRIES = 3;

<span class="fc" id="L42">  public MPDSocket(InetAddress server, int port, int timeout) {</span>
<span class="fc" id="L43">    this.server = server.getHostAddress();</span>
<span class="fc" id="L44">    this.port = port;</span>
<span class="fc" id="L45">    this.responseProperties = new ResponseProperties();</span>
<span class="fc" id="L46">    this.serverProperties = new ServerProperties();</span>
<span class="fc" id="L47">    this.encoding = serverProperties.getEncoding();</span>
<span class="fc" id="L48">    connect(timeout);</span>
<span class="fc" id="L49">  }</span>

  /**
   * If MPD is already connected no attempt will be made to connect and the mpdVersion is returned.
   *
   * &lt;p&gt;A timeout of 0 means an infinite wait.
   *
   * @param timeout socket timeout, 0 for infinite wait
   * @throws MPDConnectionException if there is a socked io problem
   */
  private synchronized void connect(int timeout) {
<span class="fc" id="L60">    connectSocket(timeout);</span>
<span class="fc" id="L61">  }</span>

  private void readVersion() {
    String line;
    try {
<span class="fc" id="L66">      line = reader.readLine();</span>
<span class="fc" id="L67">    } catch (IOException e) {</span>
<span class="fc" id="L68">      throw new MPDConnectionException(e);</span>
<span class="fc" id="L69">    }</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">    if (isResponseOK(line)) {</span>
<span class="fc" id="L72">      this.version = stripResponse(responseProperties.getOk(), line).trim();</span>
    } else {
<span class="fc" id="L74">      throw new MPDConnectionException(</span>
          &quot;Command from server: &quot;
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">              + ((line == null) ? &quot;null&quot; : stripResponse(responseProperties.getError(), line)));</span>
    }
<span class="fc" id="L78">  }</span>

  private void connectSocket(int timeout) {
<span class="fc" id="L81">    log.debug(&quot;attempting to connect socket to {} with timeout of {}&quot;, server, timeout);</span>
<span class="fc" id="L82">    this.socket = createSocket();</span>
<span class="fc" id="L83">    SocketAddress socketAddress = new InetSocketAddress(server, port);</span>
    try {
<span class="fc" id="L85">      this.socket.connect(socketAddress, timeout);</span>
<span class="fc" id="L86">      setReader(new BufferedReader(new InputStreamReader(socket.getInputStream(), encoding)));</span>
<span class="fc" id="L87">      readVersion();</span>
<span class="fc" id="L88">    } catch (Exception ioe) {</span>
<span class="fc" id="L89">      log.error(&quot;failed to connect socket to {}&quot;, server);</span>
<span class="fc" id="L90">      throw new MPDConnectionException(ioe);</span>
<span class="fc" id="L91">    }</span>
<span class="fc" id="L92">  }</span>

  protected void setReader(BufferedReader reader) {
<span class="fc" id="L95">    this.reader = reader;</span>
<span class="fc" id="L96">  }</span>

  protected Socket createSocket() {
<span class="fc" id="L99">    return new Socket();</span>
  }

  public synchronized Collection&lt;String&gt; sendCommand(MPDCommand command) {
<span class="fc" id="L103">    checkConnection();</span>

<span class="fc" id="L105">    var count = 0;</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">    while (count &lt; TRIES) {</span>
      try {
<span class="fc" id="L108">        return sendBytes(convertCommand(command.getCommand(), command.getParams()));</span>
<span class="fc" id="L109">      } catch (MPDException mpdException) {</span>
<span class="fc" id="L110">        logCommandError(command, mpdException);</span>
<span class="fc" id="L111">        throw mpdException;</span>
<span class="fc" id="L112">      } catch (Exception ex) {</span>
<span class="fc" id="L113">        logCommandError(command, ex);</span>
        try {
<span class="fc" id="L115">          connect();</span>
<span class="fc" id="L116">        } catch (Exception exc) {</span>
<span class="fc" id="L117">          log.error(&quot;Unable to connect to {} on port {}&quot;, server, port, exc);</span>
<span class="fc" id="L118">        }</span>
<span class="fc" id="L119">        ++count;</span>
<span class="fc" id="L120">        log.warn(&quot;Retrying command {} for the {} time&quot;, command.getCommand(), count);</span>
<span class="fc" id="L121">      }</span>
    }

<span class="fc" id="L124">    log.error(&quot;Unable to send command {} after {} tries&quot;, command, TRIES);</span>
<span class="fc" id="L125">    throw new MPDConnectionException(&quot;Unable to send command &quot; + command);</span>
  }

  private static void logCommandError(MPDCommand command, Exception se) {
<span class="fc" id="L129">    log.error(&quot;Error from: {}&quot;, command.getCommand(), se);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">    for (String str : command.getParams()) {</span>
<span class="fc" id="L131">      log.error(&quot;\tparam: {}&quot;, str);</span>
<span class="fc" id="L132">    }</span>
<span class="fc" id="L133">  }</span>

  /**
   * Attempts to connect to MPD with an infinite timeout value. If MPD is already connected no
   * attempt will be made to connect and the mpdVersion is returned.
   */
  private synchronized void connect() {
<span class="fc" id="L140">    connect(0);</span>
<span class="fc" id="L141">  }</span>

  private boolean isResponseOK(final String line) {
<span class="fc bfc" id="L144" title="All 2 branches covered.">    if (line == null) {</span>
<span class="fc" id="L145">      log.info(&quot;Response check failed. Line is null&quot;);</span>
<span class="fc" id="L146">      return false;</span>
    }

<span class="fc bfc" id="L149" title="All 2 branches covered.">    return line.startsWith(responseProperties.getOk())</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        || line.startsWith(responseProperties.getListOk());</span>
  }

  private boolean isResponseError(final String line) {
<span class="fc bfc" id="L154" title="All 2 branches covered.">    if (line.startsWith(responseProperties.getError())) {</span>
<span class="fc" id="L155">      log.warn(&quot;line contained an error: {}&quot;, line);</span>
<span class="fc" id="L156">      this.lastError = line.substring(responseProperties.getError().length()).trim();</span>
<span class="fc" id="L157">      return true;</span>
    } else {
<span class="fc" id="L159">      return false;</span>
    }
  }

  private static String stripResponse(String response, String line) {
<span class="fc" id="L164">    return line.substring(response.length());</span>
  }

  private static String convertCommand(String command) {
<span class="fc" id="L168">    return convertCommand(command, new ArrayList&lt;&gt;());</span>
  }

  private static String convertCommand(String command, List&lt;String&gt; params) {
<span class="fc" id="L172">    var sb = new StringBuilder(command);</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">    for (String param : params) {</span>
<span class="fc" id="L174">      param = param.replace(&quot;\&quot;&quot;, &quot;\\\\\&quot;&quot;);</span>
<span class="fc" id="L175">      sb.append(&quot; \&quot;&quot;).append(param).append(&quot;\&quot;&quot;);</span>
<span class="fc" id="L176">    }</span>

<span class="fc" id="L178">    return sb.append(&quot;\n&quot;).toString();</span>
  }

  public synchronized void sendCommands(List&lt;MPDCommand&gt; commandList) {
<span class="fc" id="L182">    var sb = new StringBuilder(convertCommand(serverProperties.getStartBulk()));</span>

<span class="fc bfc" id="L184" title="All 2 branches covered.">    for (MPDCommand command : commandList) {</span>
<span class="fc" id="L185">      sb.append(convertCommand(command.getCommand(), command.getParams()));</span>
<span class="fc" id="L186">    }</span>

<span class="fc" id="L188">    sb.append(convertCommand(serverProperties.getEndBulk()));</span>

<span class="fc" id="L190">    checkConnection();</span>

    try {
<span class="fc" id="L193">      sendBytes(sb.toString());</span>

<span class="fc" id="L195">      String line = reader.readLine();</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">      while (line != null) {</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        if (!isResponseOK(line)) {</span>
<span class="fc" id="L198">          log.warn(&quot;some command from a command list failed: {}&quot;, line);</span>
        }

<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (reader.ready()) {</span>
<span class="fc" id="L202">          line = reader.readLine();</span>
<span class="fc" id="L203">          log.warn(&quot;unexpected response line {}&quot;, line);</span>
        } else {
<span class="fc" id="L205">          line = null;</span>
        }
      }
<span class="fc" id="L208">    } catch (MPDSecurityException se) {</span>
<span class="fc" id="L209">      throw se;</span>
<span class="fc" id="L210">    } catch (Exception e) {</span>
<span class="fc" id="L211">      commandList.forEach(s -&gt; log.error(s.getCommand()));</span>
<span class="fc" id="L212">      throw new MPDConnectionException(e.getMessage(), e);</span>
<span class="fc" id="L213">    }</span>
<span class="fc" id="L214">  }</span>

  private List&lt;String&gt; sendBytes(String command) throws IOException {
<span class="fc" id="L217">    log.debug(&quot;start command: {}&quot;, command);</span>
<span class="fc" id="L218">    var response = new ArrayList&lt;String&gt;();</span>

<span class="fc" id="L220">    writeToStream(command);</span>

<span class="fc" id="L222">    var inLine = reader.readLine();</span>
<span class="fc" id="L223">    log.debug(&quot;first response line is: {}&quot;, inLine);</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">    while (inLine != null) {</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">      if (isResponseOK(inLine)) {</span>
<span class="fc" id="L226">        log.debug(&quot;the response was ok&quot;);</span>
<span class="fc" id="L227">        break;</span>
      }

<span class="fc bfc" id="L230" title="All 2 branches covered.">      if (isResponseError(inLine)) {</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (lastError.contains(&quot;you don't have permission&quot;)) {</span>
<span class="fc" id="L232">          throw new MPDSecurityException(lastError, command);</span>
        } else {
<span class="fc" id="L234">          log.error(&quot;Got error from command {}&quot;, command);</span>
<span class="fc" id="L235">          throw new MPDConnectionException(lastError);</span>
        }
      }
<span class="fc" id="L238">      response.add(inLine);</span>
<span class="fc" id="L239">      inLine = reader.readLine();</span>
    }

<span class="fc" id="L242">    response.forEach(LOGGER::debug);</span>

<span class="fc" id="L244">    return response;</span>
  }

  private void checkConnection() {
    boolean connected;

<span class="fc bfc" id="L250" title="All 2 branches covered.">    if (this.closed) {</span>
<span class="fc" id="L251">      throw new MPDConnectionException(&quot;Close has been called on MPD.  Create a new MPD.&quot;);</span>
    }

<span class="fc bfc" id="L254" title="All 2 branches covered.">    if (!socket.isConnected()) {</span>
<span class="fc" id="L255">      log.warn(&quot;socket hasn't been connected yet&quot;);</span>
<span class="fc" id="L256">      connected = false;</span>
    } else {
<span class="fc bfc" id="L258" title="All 2 branches covered.">      if (!socket.isClosed()) {</span>
<span class="fc" id="L259">        connected = checkPing();</span>
      } else {
<span class="fc" id="L261">        log.warn(&quot;socket is closed&quot;);</span>
<span class="fc" id="L262">        connected = false;</span>
      }
    }

<span class="fc bfc" id="L266" title="All 2 branches covered.">    if (!connected) {</span>
<span class="fc" id="L267">      log.info(&quot;we've lost connectivity, attempting to connect&quot;);</span>
      try {
<span class="fc" id="L269">        connect();</span>
<span class="fc" id="L270">      } catch (Exception e) {</span>
<span class="fc" id="L271">        throw new MPDConnectionException(&quot;Connection to server lost: &quot; + e.getMessage(), e);</span>
<span class="fc" id="L272">      }</span>
    }
<span class="fc" id="L274">  }</span>

  public void close() {
<span class="fc" id="L277">    this.closed = true;</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">    if (!this.socket.isClosed()) {</span>
      try {
<span class="fc" id="L280">        this.reader.close();</span>
<span class="fc" id="L281">      } catch (IOException e) {</span>
<span class="fc" id="L282">        throw new MPDConnectionException(&quot;Unable to close socket&quot;, e);</span>
<span class="fc" id="L283">      }</span>

      try {
<span class="fc" id="L286">        this.socket.close();</span>
<span class="fc" id="L287">      } catch (IOException e) {</span>
<span class="fc" id="L288">        throw new MPDConnectionException(&quot;Unable to close socket&quot;, e);</span>
<span class="fc" id="L289">      }</span>
    }
<span class="fc" id="L291">  }</span>

  private void writeToStream(String command) throws IOException {
<span class="fc" id="L294">    socket.getOutputStream().write(command.getBytes(serverProperties.getEncoding()));</span>
<span class="fc" id="L295">  }</span>

  private boolean checkPing() {
<span class="fc" id="L298">    var connected = true;</span>
    try {
<span class="fc" id="L300">      writeToStream(convertCommand(serverProperties.getPing()));</span>
<span class="fc" id="L301">      String inLine = reader.readLine();</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">      if (!isResponseOK(inLine)) {</span>
<span class="fc" id="L303">        connected = false;</span>
      }
<span class="fc" id="L305">    } catch (Exception e) {</span>
<span class="fc" id="L306">      connected = false;</span>
<span class="fc" id="L307">      log.error(&quot;lost socket connection&quot;, e);</span>
<span class="fc" id="L308">    }</span>

<span class="fc" id="L310">    return connected;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>